/* esm.sh - esbuild bundle(@getalby/lightning-tools@5.0.0) es2022 production */
var H=class{constructor(e){this.storage=void 0,this.storage=e||{}}getItem(e){return this.storage[e]}setItem(e,o){this.storage[e]=o}},ge={__proto__:null,MemoryStorage:H,NoStorage:class{constructor(a){}getItem(a){return null}setItem(a,e){}},default:H},be=new H,re=async(a,e,o)=>{o||(o={});let i=o.headerKey||"L402",s=o.webln||globalThis.webln;if(!s)throw new Error("WebLN is missing");let c=o.store||be;e||(e={}),e.cache="no-store",e.mode="cors",e.headers||(e.headers={});let d=c.getItem(a);if(d){let v=JSON.parse(d);return e.headers.Authorization=`${i} ${v.token}:${v.preimage}`,await fetch(a,e)}e.headers["Accept-Authenticate"]=i;let p=await fetch(a,e),b=p.headers.get("www-authenticate");if(!b)return p;let S=(v=>{let L=v.replace("L402","").replace("LSAT","").trim(),I={},U=/(\w+)=("([^"]*)"|'([^']*)'|([^,]*))/g,y;for(;(y=U.exec(L))!==null;)I[y[1]]=y[3]||y[4]||y[5];return I})(b),x=S.token||S.macaroon,D=S.invoice;await s.enable();let k=await s.sendPayment(D);return c.setItem(a,JSON.stringify({token:x,preimage:k.preimage})),e.headers.Authorization=`${i} ${x}:${k.preimage}`,await fetch(a,e)},Se={__proto__:null,storage:ge,fetchWithL402:re,default:re},Z=async(a,e)=>{let{boost:o}=a;e||(e={});let i=e.webln||globalThis.webln;if(!i)throw new Error("WebLN not available");if(!i.keysend)throw new Error("Keysend not available in current WebLN provider");let s=a.amount||Math.floor(o.value_msat/1e3),c={destination:a.destination,amount:s,customRecords:{7629169:JSON.stringify(o)}};return a.customKey&&a.customValue&&(c.customRecords[a.customKey]=a.customValue),await i.enable(),await i.keysend(c)},Ie={__proto__:null,boost:Z,default:Z};function G(){return G=Object.assign?Object.assign.bind():function(a){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(a[i]=o[i])}return a},G.apply(this,arguments)}async function z(a){let e=typeof a=="string"?new TextEncoder().encode(a):a,o=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(o)).map(i=>i.toString(16).padStart(2,"0")).join("")}var ve=/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=+$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=+$,\w]+@)[A-Za-z0-9.-]+)((?:\/[+~%/.\w-_]*)?\??(?:[-+=&;%@.\w_]*)#?(?:[\w]*))?)/,te=a=>!!a&&ve.test(a),ne=({amount:a,min:e,max:o})=>a>0&&a>=e&&a<=o,oe,J,Ee=(oe=function(a,e){function o(r){if(!Number.isSafeInteger(r))throw new Error(`Wrong integer: ${r}`)}function i(...r){let t=(n,l)=>h=>n(l(h));return{encode:Array.from(r).reverse().reduce((n,l)=>n?t(n,l.encode):l.encode,void 0),decode:r.reduce((n,l)=>n?t(n,l.decode):l.decode,void 0)}}function s(r){return{encode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return t.map(n=>{if(o(n),n<0||n>=r.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${r.length})`);return r[n]})},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("alphabet.decode input should be array of strings");return t.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);let l=r.indexOf(n);if(l===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${r}`);return l})}}}function c(r=""){if(typeof r!="string")throw new Error("join separator should be string");return{encode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of t)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return t.join(r)},decode:t=>{if(typeof t!="string")throw new Error("join.decode input should be string");return t.split(r)}}}function d(r,t="="){if(o(r),typeof t!="string")throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let l of n)if(typeof l!="string")throw new Error(`padding.encode: non-string input=${l}`);for(;n.length*r%8;)n.push(t);return n},decode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let h of n)if(typeof h!="string")throw new Error(`padding.decode: non-string input=${h}`);let l=n.length;if(l*r%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;l>0&&n[l-1]===t;l--)if(!((l-1)*r%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,l)}}}function p(r){if(typeof r!="function")throw new Error("normalize fn should be function");return{encode:t=>t,decode:t=>r(t)}}function b(r,t,n){if(t<2)throw new Error(`convertRadix: wrong from=${t}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: wrong to=${n}, base cannot be less than 2`);if(!Array.isArray(r))throw new Error("convertRadix: data should be array");if(!r.length)return[];let l=0,h=[],u=Array.from(r);for(u.forEach(f=>{if(o(f),f<0||f>=t)throw new Error(`Wrong integer: ${f}`)});;){let f=0,w=!0;for(let m=l;m<u.length;m++){let N=u[m],A=t*f+N;if(!Number.isSafeInteger(A)||t*f/t!==f||A-N!=t*f)throw new Error("convertRadix: carry overflow");if(f=A%n,u[m]=Math.floor(A/n),!Number.isSafeInteger(u[m])||u[m]*n+f!==A)throw new Error("convertRadix: carry overflow");w&&(u[m]?w=!1:l=m)}if(h.push(f),w)break}for(let f=0;f<r.length-1&&r[f]===0;f++)h.push(0);return h.reverse()}Object.defineProperty(e,"__esModule",{value:!0}),e.bytes=e.stringToBytes=e.str=e.bytesToString=e.hex=e.utf8=e.bech32m=e.bech32=e.base58check=e.base58xmr=e.base58xrp=e.base58flickr=e.base58=e.base64url=e.base64=e.base32crockford=e.base32hex=e.base32=e.base16=e.utils=e.assertNumber=void 0,e.assertNumber=o;let S=(r,t)=>t?S(t,r%t):r,x=(r,t)=>r+(t-S(r,t));function D(r,t,n,l){if(!Array.isArray(r))throw new Error("convertRadix2: data should be array");if(t<=0||t>32)throw new Error(`convertRadix2: wrong from=${t}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(x(t,n)>32)throw new Error(`convertRadix2: carry overflow from=${t} to=${n} carryBits=${x(t,n)}`);let h=0,u=0,f=2**n-1,w=[];for(let m of r){if(o(m),m>=2**t)throw new Error(`convertRadix2: invalid data word=${m} from=${t}`);if(h=h<<t|m,u+t>32)throw new Error(`convertRadix2: carry overflow pos=${u} from=${t}`);for(u+=t;u>=n;u-=n)w.push((h>>u-n&f)>>>0);h&=2**u-1}if(h=h<<n-u&f,!l&&u>=t)throw new Error("Excess padding");if(!l&&h)throw new Error(`Non-zero padding: ${h}`);return l&&u>0&&w.push(h>>>0),w}function k(r){return o(r),{encode:t=>{if(!(t instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return b(Array.from(t),256,r)},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(b(t,r,256))}}}function v(r,t=!1){if(o(r),r<=0||r>32)throw new Error("radix2: bits should be in (0..32]");if(x(8,r)>32||x(r,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return D(Array.from(n),8,r,!t)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(D(n,r,8,t))}}}function L(r){if(typeof r!="function")throw new Error("unsafeWrapper fn should be function");return function(...t){try{return r.apply(null,t)}catch{}}}function I(r,t){if(o(r),typeof t!="function")throw new Error("checksum fn should be function");return{encode(n){if(!(n instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");let l=t(n).slice(0,r),h=new Uint8Array(n.length+r);return h.set(n),h.set(l,n.length),h},decode(n){if(!(n instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");let l=n.slice(0,-r),h=t(l).slice(0,r),u=n.slice(-r);for(let f=0;f<r;f++)if(h[f]!==u[f])throw new Error("Invalid checksum");return l}}}e.utils={alphabet:s,chain:i,checksum:I,radix:k,radix2:v,join:c,padding:d},e.base16=i(v(4),s("0123456789ABCDEF"),c("")),e.base32=i(v(5),s("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),d(5),c("")),e.base32hex=i(v(5),s("0123456789ABCDEFGHIJKLMNOPQRSTUV"),d(5),c("")),e.base32crockford=i(v(5),s("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),c(""),p(r=>r.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),e.base64=i(v(6),s("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),d(6),c("")),e.base64url=i(v(6),s("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),d(6),c(""));let U=r=>i(k(58),s(r),c(""));e.base58=U("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.base58flickr=U("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),e.base58xrp=U("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");let y=[0,2,3,5,6,7,9,10,11];e.base58xmr={encode(r){let t="";for(let n=0;n<r.length;n+=8){let l=r.subarray(n,n+8);t+=e.base58.encode(l).padStart(y[l.length],"1")}return t},decode(r){let t=[];for(let n=0;n<r.length;n+=11){let l=r.slice(n,n+11),h=y.indexOf(l.length),u=e.base58.decode(l);for(let f=0;f<u.length-h;f++)if(u[f]!==0)throw new Error("base58xmr: wrong padding");t=t.concat(Array.from(u.slice(u.length-h)))}return Uint8Array.from(t)}},e.base58check=r=>i(I(4,t=>r(r(t))),e.base58);let K=i(s("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),c("")),$=[996825010,642813549,513874426,1027748829,705979059];function T(r){let t=r>>25,n=(33554431&r)<<5;for(let l=0;l<$.length;l++)(t>>l&1)==1&&(n^=$[l]);return n}function O(r,t,n=1){let l=r.length,h=1;for(let u=0;u<l;u++){let f=r.charCodeAt(u);if(f<33||f>126)throw new Error(`Invalid prefix (${r})`);h=T(h)^f>>5}h=T(h);for(let u=0;u<l;u++)h=T(h)^31&r.charCodeAt(u);for(let u of t)h=T(h)^u;for(let u=0;u<6;u++)h=T(h);return h^=n,K.encode(D([h%2**30],30,5,!1))}function E(r){let t=r==="bech32"?1:734539939,n=v(5),l=n.decode,h=n.encode,u=L(l);function f(w,m=90){if(typeof w!="string")throw new Error("bech32.decode input should be string, not "+typeof w);if(w.length<8||m!==!1&&w.length>m)throw new TypeError(`Wrong string length: ${w.length} (${w}). Expected (8..${m})`);let N=w.toLowerCase();if(w!==N&&w!==w.toUpperCase())throw new Error("String must be lowercase or uppercase");let A=(w=N).lastIndexOf("1");if(A===0||A===-1)throw new Error('Letter "1" must be present between prefix and data only');let B=w.slice(0,A),g=w.slice(A+1);if(g.length<6)throw new Error("Data must be at least 6 characters long");let j=K.decode(g).slice(0,-6),P=O(B,j,t);if(!g.endsWith(P))throw new Error(`Invalid checksum in ${w}: expected "${P}"`);return{prefix:B,words:j}}return{encode:function(w,m,N=90){if(typeof w!="string")throw new Error("bech32.encode prefix should be string, not "+typeof w);if(!Array.isArray(m)||m.length&&typeof m[0]!="number")throw new Error("bech32.encode words should be array of numbers, not "+typeof m);let A=w.length+7+m.length;if(N!==!1&&A>N)throw new TypeError(`Length ${A} exceeds limit ${N}`);return`${w=w.toLowerCase()}1${K.encode(m)}${O(w,m,t)}`},decode:f,decodeToBytes:function(w){let{prefix:m,words:N}=f(w,!1);return{prefix:m,words:N,bytes:l(N)}},decodeUnsafe:L(f),fromWords:l,fromWordsUnsafe:u,toWords:h}}e.bech32=E("bech32"),e.bech32m=E("bech32m"),e.utf8={encode:r=>new TextDecoder().decode(r),decode:r=>new TextEncoder().encode(r)},e.hex=i(v(4),s("0123456789abcdef"),c(""),p(r=>{if(typeof r!="string"||r.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof r} with length ${r.length}`);return r.toLowerCase()}));let _={utf8:e.utf8,hex:e.hex,base16:e.base16,base32:e.base32,base64:e.base64,base64url:e.base64url,base58:e.base58,base58xmr:e.base58xmr},V=`Invalid encoding type. Available types: ${Object.keys(_).join(", ")}`;e.bytesToString=(r,t)=>{if(typeof r!="string"||!_.hasOwnProperty(r))throw new TypeError(V);if(!(t instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return _[r].encode(t)},e.str=e.bytesToString,e.stringToBytes=(r,t)=>{if(!_.hasOwnProperty(r))throw new TypeError(V);if(typeof t!="string")throw new TypeError("stringToBytes() expects string");return _[r].decode(t)},e.bytes=e.stringToBytes},oe(J={exports:{}},J.exports),J.exports),{bech32:W,hex:R,utf8:xe}=Ee,ae={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0]},se={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},ie={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},ce={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0]},C=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],_e={m:BigInt(1e3),u:BigInt(1e6),n:BigInt(1e9),p:BigInt(1e12)},Ae=BigInt("2100000000000000000"),le=BigInt(1e11),X={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27},de={};for(let a=0,e=Object.keys(X);a<e.length;a++){let o=e[a],i=X[e[a]].toString();de[i]=o}var ke={1:a=>R.encode(W.fromWordsUnsafe(a)),16:a=>R.encode(W.fromWordsUnsafe(a)),13:a=>xe.encode(W.fromWordsUnsafe(a)),19:a=>R.encode(W.fromWordsUnsafe(a)),23:a=>R.encode(W.fromWordsUnsafe(a)),27:a=>R.encode(W.fromWordsUnsafe(a)),6:M,24:M,3:function(a){let e=[],o,i,s,c,d,p=W.fromWordsUnsafe(a);for(;p.length>0;)o=R.encode(p.slice(0,33)),i=R.encode(p.slice(33,41)),s=parseInt(R.encode(p.slice(41,45)),16),c=parseInt(R.encode(p.slice(45,49)),16),d=parseInt(R.encode(p.slice(49,51)),16),p=p.slice(51),e.push({pubkey:o,short_channel_id:i,fee_base_msat:s,fee_proportional_millionths:c,cltv_expiry_delta:d});return e},5:function(a){let e=a.slice().reverse().map(s=>[!!(1&s),!!(2&s),!!(4&s),!!(8&s),!!(16&s)]).reduce((s,c)=>s.concat(c),[]);for(;e.length<2*C.length;)e.push(!1);let o={};C.forEach((s,c)=>{let d;d=e[2*c]?"required":e[2*c+1]?"supported":"unsupported",o[s]=d});let i=e.slice(2*C.length);return o.extra_bits={start_bit:2*C.length,bits:i,has_required:i.reduce((s,c,d)=>d%2!=0?s||!1:s||c,!1)},o}};function $e(a){return e=>({tagCode:parseInt(a),words:W.encode("unknown",e,Number.MAX_SAFE_INTEGER)})}function M(a){return a.reverse().reduce((e,o,i)=>e+o*Math.pow(32,i),0)}var Q=class{constructor(e){var o,i,s;if(this.paymentRequest=void 0,this.paymentHash=void 0,this.preimage=void 0,this.verify=void 0,this.satoshi=void 0,this.expiry=void 0,this.timestamp=void 0,this.createdDate=void 0,this.expiryDate=void 0,this.description=void 0,this.paymentRequest=e.pr,!this.paymentRequest)throw new Error("Invalid payment request");let c=(d=>{if(!d)return null;try{let p=function(y,K){if(typeof y!="string")throw new Error("Lightning Payment Request must be string");if(y.slice(0,2).toLowerCase()!=="ln")throw new Error("Not a proper lightning payment request");let $=[],T=W.decode(y,Number.MAX_SAFE_INTEGER);y=y.toLowerCase();let O=T.prefix,E=T.words,_=y.slice(O.length+1),V=E.slice(-104);E=E.slice(0,-104);let r=O.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(r&&!r[2]&&(r=O.match(/^ln(\S+)$/)),!r)throw new Error("Not a proper lightning payment request");$.push({name:"lightning_network",letters:"ln"});let t=r[1],n;switch(t){case ae.bech32:n=ae;break;case se.bech32:n=se;break;case ie.bech32:n=ie;break;case ce.bech32:n=ce}if(!n||n.bech32!==t)throw new Error("Unknown coin bech32 prefix");$.push({name:"coin_network",letters:t,value:n});let l=r[2],h;l?(h=function(g,j){let P,q;if(g.slice(-1).match(/^[munp]$/))P=g.slice(-1),q=g.slice(0,-1);else{if(g.slice(-1).match(/^[^munp0-9]$/))throw new Error("Not a valid multiplier for the amount");q=g}if(!q.match(/^\d+$/))throw new Error("Not a valid human readable amount");let F=BigInt(q),ee=P?F*le/_e[P]:F*le;if(P==="p"&&F%BigInt(10)!==BigInt(0)||ee>Ae)throw new Error("Amount is outside of valid range");return ee.toString()}(l+r[3]),$.push({name:"amount",letters:r[2]+r[3],value:h})):h=null,$.push({name:"separator",letters:"1"});let u=M(E.slice(0,7)),f,w,m,N;for(E=E.slice(7),$.push({name:"timestamp",letters:_.slice(0,7),value:u}),_=_.slice(7);E.length>0;){let g=E[0].toString();f=de[g]||"unknown_tag",w=ke[g]||$e(g),E=E.slice(1),m=M(E.slice(0,2)),E=E.slice(2),N=E.slice(0,m),E=E.slice(m),$.push({name:f,tag:_[0],letters:_.slice(0,3+m),value:w(N)}),_=_.slice(3+m)}$.push({name:"signature",letters:_.slice(0,104),value:R.encode(W.fromWordsUnsafe(V))}),_=_.slice(104),$.push({name:"checksum",letters:_});let A={paymentRequest:y,sections:$,get expiry(){let g=$.find(j=>j.name==="expiry");if(g)return B("timestamp")+g.value},get route_hints(){return $.filter(g=>g.name==="route_hint").map(g=>g.value)}};for(let g in X)g!=="route_hint"&&Object.defineProperty(A,g,{get:()=>B(g)});return A;function B(g){let j=$.find(P=>P.name===g);return j?j.value:void 0}}(d);if(!p||!p.sections)return null;let b=p.sections.find(y=>y.name==="payment_hash");if(b?.name!=="payment_hash"||!b.value)return null;let S=b.value,x=p.sections.find(y=>y.name==="amount");if(x?.name!=="amount"||x.value===void 0)return null;let D=parseInt(x.value)/1e3,k=p.sections.find(y=>y.name==="expiry"),v=p.sections.find(y=>y.name==="timestamp");if(v?.name!=="timestamp"||!v.value)return null;let L=v.value;if(k?.name!=="expiry"||k.value===void 0)return null;let I=k.value,U=p.sections.find(y=>y.name==="description");return{paymentHash:S,satoshi:D,timestamp:L,expiry:I,description:U?.name==="description"?U?.value:void 0}}catch{return null}})(this.paymentRequest);if(!c)throw new Error("Failed to decode payment request");this.paymentHash=c.paymentHash,this.satoshi=c.satoshi,this.timestamp=c.timestamp,this.expiry=c.expiry,this.createdDate=new Date(1e3*this.timestamp),this.expiryDate=new Date(1e3*(this.timestamp+this.expiry)),this.description=(o=c.description)!=null?o:null,this.verify=(i=e.verify)!=null?i:null,this.preimage=(s=e.preimage)!=null?s:null}async isPaid(){if(this.preimage)return this.validatePreimage(this.preimage);if(this.verify)return await this.verifyPayment();throw new Error("Could not verify payment")}async validatePreimage(e){if(!e||!this.paymentHash)return!1;try{let i=await z((o=e,Uint8Array.from(o.match(/.{1,2}/g).map(s=>parseInt(s,16)))));return this.paymentHash===i}catch{return!1}var o}async verifyPayment(){if(!this.verify)throw new Error("LNURL verify not available");let e=await fetch(this.verify),o=await e.json();return o.preimage&&(this.preimage=o.preimage),o.settled}};async function fe({satoshi:a,comment:e,p:o,e:i,relays:s},c={}){let d=c.nostr||globalThis.nostr;if(!d)throw new Error("nostr option or window.nostr is not available");let p=[["relays",...s],["amount",a.toString()]];o&&p.push(["p",o]),i&&p.push(["e",i]);let b={pubkey:await d.getPublicKey(),created_at:Math.floor(Date.now()/1e3),kind:9734,tags:p,content:e??""};return b.id=await me(b),await d.signEvent(b)}function pe(a){if(typeof a.content!="string"||typeof a.created_at!="number"||!Array.isArray(a.tags))return!1;for(let e=0;e<a.tags.length;e++){let o=a.tags[e];if(!Array.isArray(o))return!1;for(let i=0;i<o.length;i++)if(typeof o[i]=="object")return!1}return!0}function we(a){if(!pe(a))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,a.pubkey,a.created_at,a.kind,a.tags,a.content])}function me(a){return z(we(a))}function ye(a,e){let o,i;var s,c;return e&&a&&(o=(s=a.names)==null?void 0:s[e],i=o?(c=a.relays)==null?void 0:c[o]:void 0),[a,o,i]}var Ue={__proto__:null,generateZapEvent:fe,validateEvent:pe,serializeEvent:we,getEventHash:me,parseNostrResponse:ye},Ne=/^((?:[^<>()[\]\\.,;:\s@"]+(?:\.[^<>()[\]\\.,;:\s@"]+)*)|(?:".+"))@((?:\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(?:(?:[a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,he=class{constructor(e,o){this.address=void 0,this.options=void 0,this.username=void 0,this.domain=void 0,this.pubkey=void 0,this.lnurlpData=void 0,this.keysendData=void 0,this.nostrData=void 0,this.nostrPubkey=void 0,this.nostrRelays=void 0,this.webln=void 0,this.address=e,this.options={proxy:"https://api.getalby.com/lnurl"},this.options=Object.assign(this.options,o),this.parse(),this.webln=this.options.webln}parse(){let e=Ne.exec(this.address.toLowerCase());e&&(this.username=e[1],this.domain=e[2])}getWebLN(){return this.webln||globalThis.webln}async fetch(){return this.options.proxy?this.fetchWithProxy():this.fetchWithoutProxy()}async fetchWithProxy(){let e=await fetch(`${this.options.proxy}/lightning-address-details?${new URLSearchParams({ln:this.address}).toString()}`),o=await e.json();await this.parseResponse(o.lnurlp,o.keysend,o.nostr)}async fetchWithoutProxy(){if(!this.domain||!this.username)return;let e=await fetch(this.lnurlpUrl()),o=await fetch(this.keysendUrl()),i=await fetch(this.nostrUrl()),s,c,d;e.ok&&(s=await e.json()),o.ok&&(c=await o.json()),i.ok&&(d=await i.json()),await this.parseResponse(s,c,d)}lnurlpUrl(){return`https://${this.domain}/.well-known/lnurlp/${this.username}`}keysendUrl(){return`https://${this.domain}/.well-known/keysend/${this.username}`}nostrUrl(){return`https://${this.domain}/.well-known/nostr.json?name=${this.username}`}async generateInvoice(e){let o;if(this.options.proxy)o=(await(await fetch(`${this.options.proxy}/generate-invoice?${new URLSearchParams(G({ln:this.address},e)).toString()}`)).json()).invoice;else{if(!this.lnurlpData)throw new Error("No lnurlpData available. Please call fetch() first.");if(!this.lnurlpData.callback||!te(this.lnurlpData.callback))throw new Error("Valid callback does not exist in lnurlpData");let c=new URL(this.lnurlpData.callback);c.search=new URLSearchParams(e).toString(),o=await(await fetch(c.toString())).json()}let i=o&&o.pr&&o.pr.toString();if(!i)throw new Error("Invalid pay service invoice");let s={pr:i};return o&&o.verify&&(s.verify=o.verify.toString()),new Q(s)}async requestInvoice(e){if(!this.lnurlpData)throw new Error("No lnurlpData available. Please call fetch() first.");let o=1e3*e.satoshi,{commentAllowed:i,min:s,max:c}=this.lnurlpData;if(!ne({amount:o,min:s,max:c}))throw new Error("Invalid amount");if(e.comment&&i&&i>0&&e.comment.length>i)throw new Error(`The comment length must be ${i} characters or fewer`);let d={amount:o.toString()};return e.comment&&(d.comment=e.comment),e.payerdata&&(d.payerdata=JSON.stringify(e.payerdata)),this.generateInvoice(d)}async boost(e,o=0){if(!this.keysendData)throw new Error("No keysendData available. Please call fetch() first.");let{destination:i,customKey:s,customValue:c}=this.keysendData,d=this.getWebLN();if(!d)throw new Error("WebLN not available");return Z({destination:i,customKey:s,customValue:c,amount:o,boost:e},{webln:d})}async zapInvoice({satoshi:e,comment:o,relays:i,e:s},c={}){if(!this.lnurlpData)throw new Error("No lnurlpData available. Please call fetch() first.");if(!this.nostrPubkey)throw new Error("Nostr Pubkey is missing");let d=this.nostrPubkey,p=1e3*e,{allowsNostr:b,min:S,max:x}=this.lnurlpData;if(!ne({amount:p,min:S,max:x}))throw new Error("Invalid amount");if(!b)throw new Error("Your provider does not support zaps");let D=await fe({satoshi:p,comment:o,p:d,e:s,relays:i},c),k={amount:p.toString(),nostr:JSON.stringify(D)};return await this.generateInvoice(k)}async zap(e,o={}){let i=this.zapInvoice(e,o),s=this.getWebLN();if(!s)throw new Error("WebLN not available");return await s.enable(),s.sendPayment((await i).paymentRequest)}async parseResponse(e,o,i){e&&(this.lnurlpData=await(async s=>{if(s.tag!=="payRequest")throw new Error("Invalid pay service params");let c=(s.callback+"").trim();if(!te(c))throw new Error("Callback must be a valid url");let d=Math.ceil(Number(s.minSendable||0)),p=Math.floor(Number(s.maxSendable));if(!d||!p||d>p)throw new Error("Invalid pay service params");let b,S;try{b=JSON.parse(s.metadata+""),S=await z(s.metadata+"")}catch{b=[],S=await z("[]")}let x="",D="",k="";for(let I=0;I<b.length;I++){let[U,y]=b[I];switch(U){case"text/plain":D=y;break;case"text/identifier":k=y;break;case"image/png;base64":case"image/jpeg;base64":x="data:"+U+","+y}}let v=s.payerData,L;try{L=new URL(c).hostname}catch{}return{callback:c,fixed:d===p,min:d,max:p,domain:L,metadata:b,metadataHash:S,identifier:k,description:D,image:x,payerData:v,commentAllowed:Number(s.commentAllowed)||0,rawData:s,allowsNostr:s.allowsNostr||!1}})(e)),o&&(this.keysendData=(s=>{if(s.tag!=="keysend")throw new Error("Invalid keysend params");if(s.status!=="OK")throw new Error("Keysend status not OK");if(!("customKey"in s.customData[0])||s.customData[0].customKey!="696969")throw new Error("Unable to find customKey");if(!("customValue"in s.customData[0])||!s.customData[0].customValue)throw new Error("Unable to find customValue");if(!s.pubkey)throw new Error("Pubkey does not exist");return{destination:s.pubkey,customKey:s.customData[0].customKey,customValue:s.customData[0].customValue}})(o)),i&&([this.nostrData,this.nostrPubkey,this.nostrRelays]=ye(i,this.username))}},Y=async a=>{let e="https://getalby.com/api/rates/"+a.toLowerCase()+".json";return(await(await fetch(e)).json()).rate_float/1e8},ue=async({satoshi:a,currency:e})=>{let o=await Y(e);return Number(a)*o},De={__proto__:null,getFiatBtcRate:Y,getFiatValue:ue,getSatoshiValue:async({amount:a,currency:e})=>{let o=await Y(e);return Math.floor(Number(a)/o)},getFormattedFiatValue:async({satoshi:a,currency:e,locale:o})=>(o||(o="en"),(await ue({satoshi:a,currency:e})).toLocaleString(o,{style:"currency",currency:e}))};export{Q as Invoice,he as LightningAddress,Ie as boostagrams,re as fetchWithL402,De as fiat,Se as l402,Ue as nostr,Z as sendBoostagram};
//# sourceMappingURL=lightning-tools.mjs.map