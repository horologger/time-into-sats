/* esm.sh - esbuild bundle(@getalby/sdk@3.2.3) es2022 production */
import I from"/v135/node_events.js";import{generatePrivateKey as M,relayInit as W,nip19 as T,getPublicKey as L,finishEvent as j,getEventHash as z,nip04 as R}from"/v135/nostr-tools@1.17.0/es2022/nostr-tools.mjs";function i(){return i=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=t[s])}return n},i.apply(this,arguments)}function q(n,e){if(n==null)return{};var t,s,r={},o=Object.keys(n);for(s=0;s<o.length;s++)e.indexOf(t=o[s])>=0||(r[t]=n[t]);return r}function N(n){return Object.entries(n).map(([e,t])=>e&&t?`${e}=${t}`:"").filter(e=>e).join("&")}function O(n,e){return`Basic ${btoa(`${n}:${e}`)}`}var v=class extends Error{constructor(e,t,s,r){let o=e.toString();t&&(o+=` ${t}`),o+=": ",o+=r.message?r.message:JSON.stringify(r),super(o),this.status=void 0,this.statusText=void 0,this.headers=void 0,this.error=void 0,this.status=e,this.statusText=t,this.headers=s,this.error=r}},Z={__proto__:null,OAuthClient:class{},AuthClient:class{},AlbyResponseError:v},K=["auth","endpoint","params","request_body","method","max_retries","base_url","user_agent","headers"],B="https://api.getalby.com";async function C(n,e,t=0){let s=await fetch(n,e);if(s.status===429&&t>0){let r=Number(s.headers.get("x-rate-limit-reset")),o=Number(s.headers.get("x-rate-limit-remaining")),h=1e3*r-Date.now(),c=1e3;return o===0&&(c=h),await new Promise(a=>setTimeout(a,c)),C(n,e,t-1)}return s}async function G(n){let{auth:e,endpoint:t,params:s={},request_body:r,method:o,max_retries:h,base_url:c=B,user_agent:a,headers:l}=n,p=q(n,K),d=new URL(c+t);d.search=N(s);let w=o==="POST"&&!!r,g=e?await e.getAuthHeader(d.href,o):void 0,m=await C(d.toString(),i({headers:i({},w?{"Content-Type":"application/json; charset=utf-8"}:void 0,g,l,{"User-Agent":a??"@getalby/sdk","X-User-Agent":a??"@getalby/sdk"}),method:o,body:w?JSON.stringify(r):void 0},p),h);if(!m.ok){let f=await m.json();throw new v(m.status,m.statusText,m.headers,f)}return m}async function u(n){return(await G(n)).json()}var H=["expires_in"],J=["token"];function x(n){let{expires_in:e}=n;return i({},q(n,H),!!e&&{expires_at:Date.now()+1e3*e})}var _=class{constructor(e){this.bearer_token=void 0,this.bearer_token=e}getAuthHeader(){return{Authorization:`Bearer ${this.bearer_token}`}}},ee={__proto__:null,OAuth2User:class{constructor(n){this.token=void 0,this.options=void 0,this.code_verifier=void 0,this.code_challenge=void 0,this._refreshAccessTokenPromise=void 0,this._tokenEvents=void 0,this._tokenEvents=new I;let{token:e}=n,t=q(n,J);this.options=i({client_secret:""},t),this.token=e,this._refreshAccessTokenPromise=null}on(n,e){this._tokenEvents.on(n,e)}async refreshAccessToken(){var n=this;return this._refreshAccessTokenPromise||(this._refreshAccessTokenPromise=new Promise(async function(e,t){try{var s;let r=(s=n.token)==null?void 0:s.refresh_token,{client_id:o,client_secret:h,request_options:c,user_agent:a}=n.options;if(!o)throw new Error("client_id is required");if(!r)throw new Error("refresh_token is required");let l=x(await u(i({},c,{endpoint:"/oauth/token",params:{client_id:o,grant_type:"refresh_token",refresh_token:r},user_agent:a,method:"POST",headers:i({},c?.headers,{"Content-type":"application/x-www-form-urlencoded"},{Authorization:O(o,h)})})));n.token=l,e({token:l}),n._tokenEvents.emit("tokenRefreshed",n.token)}catch(r){console.error(r),t(r),n._tokenEvents.emit("tokenRefreshFailed",r)}finally{n._refreshAccessTokenPromise=null}})),this._refreshAccessTokenPromise}isAccessTokenExpired(){var n,e;let t=(n=this.token)==null?void 0:n.refresh_token,s=(e=this.token)==null?void 0:e.expires_at;return!s||!!t&&s<=Date.now()+1e3}async requestAccessToken(n){let{client_id:e,client_secret:t,callback:s,request_options:r,user_agent:o}=this.options,h=this.code_verifier;if(!e)throw new Error("client_id is required");if(!t&&!h)throw new Error("either client_secret is required, or code should be generated using a challenge");if(!s)throw new Error("callback is required");let c={code:n,grant_type:"authorization_code",code_verifier:h,client_id:e,redirect_uri:s},a=x(await u(i({},r,{endpoint:"/oauth/token",params:c,user_agent:o,method:"POST",headers:i({},r?.headers,{"Content-Type":"application/x-www-form-urlencoded"},{Authorization:O(e,t)})})));return this.token=a,{token:a}}async generateAuthURL(n){n||(n={});let{client_id:e,callback:t,scopes:s}=this.options;if(!t)throw new Error("callback required");if(!s)throw new Error("scopes required");let r;n.code_challenge_method==="S256"?(await this._generateS256Challenge(),r="S256"):n.code_challenge_method==="plain"&&n.code_challenge&&(this.code_challenge=n.code_challenge,this.code_verifier=n.code_challenge,r="plain");let o=this.code_challenge,h=new URL(n.authorizeUrl||"https://getalby.com/oauth");return h.search=N(i({},n,{client_id:e,scope:s.join(" "),response_type:"code",redirect_uri:t,code_challenge_method:r,code_challenge:o})),h.toString()}async getAuthHeader(){var n;if((n=this.token)==null||!n.access_token)throw new Error("access_token is required");return this.isAccessTokenExpired()&&await this.refreshAccessToken(),{Authorization:`Bearer ${this.token.access_token}`}}async _generateS256Challenge(){let n=crypto.getRandomValues(new Uint8Array(64));this.code_verifier=n.reduce((s,r)=>s+r.toString(16).padStart(2,"0"),"");let e=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(this.code_verifier)),t=new Uint8Array(e);this.code_challenge=btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}},OAuth2Bearer:_},D={alby:{authorizationUrl:"https://nwc.getalby.com/apps/new",relayUrl:"wss://relay.getalby.com/v1",walletPubkey:"69effe7b49a6dd5cf525bd0905917a5005ffe480b58eeb8e861418cf3ae760d9"}},S={get_info:"getInfo",get_balance:"getBalance",make_invoice:"makeInvoice",pay_invoice:"sendPayment",pay_keysend:"payKeysend",lookup_invoice:"lookupInvoice",list_transactions:"listTransactions"},k=class n{static parseWalletConnectUrl(e){e=e.replace("nostrwalletconnect://","http://").replace("nostr+walletconnect://","http://");let t=new URL(e),s={};s.walletPubkey=t.host;let r=t.searchParams.get("secret"),o=t.searchParams.get("relay");return r&&(s.secret=r),o&&(s.relayUrl=o),s}static withNewSecret(e){return(e=e||{}).secret=M(),new n(e)}constructor(e){var t;this.relay=void 0,this.relayUrl=void 0,this.secret=void 0,this.walletPubkey=void 0,this.options=void 0,this.subscribers=void 0,this._enabled=!1,e&&e.nostrWalletConnectUrl&&(e=i({},n.parseWalletConnectUrl(e.nostrWalletConnectUrl),e));let s=D[((t=e)==null?void 0:t.providerName)||"alby"];this.options=i({},s,e||{}),this.relayUrl=this.options.relayUrl,this.relay=W(this.relayUrl),this.options.secret&&(this.secret=this.options.secret.toLowerCase().startsWith("nsec")?T.decode(this.options.secret).data:this.options.secret),this.walletPubkey=this.options.walletPubkey.toLowerCase().startsWith("npub")?T.decode(this.options.walletPubkey).data:this.options.walletPubkey,this.subscribers={},globalThis.WebSocket===void 0&&console.error("WebSocket is undefined. Make sure to `import websocket-polyfill` for nodejs environments")}on(e,t){this.subscribers[e]=t}notify(e,t){let s=this.subscribers[e];s&&s(t)}getNostrWalletConnectUrl(e=!0){let t=`nostr+walletconnect://${this.walletPubkey}?relay=${this.relayUrl}&pubkey=${this.publicKey}`;return e&&(t=`${t}&secret=${this.secret}`),t}get nostrWalletConnectUrl(){return this.getNostrWalletConnectUrl()}get connected(){return this.relay.status===1}get publicKey(){if(!this.secret)throw new Error("Missing secret key");return L(this.secret)}getPublicKey(){return Promise.resolve(this.publicKey)}signEvent(e){if(!this.secret)throw new Error("Missing secret key");return Promise.resolve(j(e,this.secret))}getEventHash(e){return z(e)}async enable(){this._enabled=!0}close(){return this.relay.close()}async encrypt(e,t){if(!this.secret)throw new Error("Missing secret");return await R.encrypt(this.secret,e,t)}async decrypt(e,t){if(!this.secret)throw new Error("Missing secret");return await R.decrypt(this.secret,e,t)}async getInfo(){await this.checkConnected();let e=["lightning","nostr"],t="Alby JS SDK";try{return await this.executeNip47Request("get_info",void 0,s=>!!s.methods,s=>({methods:s.methods.map(r=>S[r]),node:{alias:s.alias,pubkey:s.pubkey,color:s.color},supports:e,version:t}))}catch(s){return console.error("Failed to request get_info",s),{methods:["sendPayment"],node:{},supports:e,version:t}}}async getBalance(){return await this.checkConnected(),this.executeNip47Request("get_balance",void 0,e=>e.balance!==void 0,e=>({balance:Math.floor(e.balance/1e3),currency:"sats"}))}async sendPayment(e){return await this.checkConnected(),this.executeNip47Request("pay_invoice",{invoice:e},t=>!!t.preimage,t=>({preimage:t.preimage}))}async keysend(e){return await this.checkConnected(),this.executeNip47Request("pay_keysend",{amount:1e3*+e.amount,pubkey:e.destination,tlv_records:e.customRecords?Object.entries(e.customRecords).map(t=>({type:parseInt(t[0]),value:t[1]})):[]},t=>!!t.preimage,t=>({preimage:t.preimage}))}lnurl(e){throw new Error("Method not implemented.")}async makeInvoice(e){var t;await this.checkConnected();let s=typeof e=="object"?e:void 0,r=+((t=s?.amount)!=null?t:e);if(!r)throw new Error("No amount specified");return this.executeNip47Request("make_invoice",{amount:1e3*r,description:s?.defaultMemo},o=>!!o.invoice,o=>({paymentRequest:o.invoice}))}async lookupInvoice(e){return await this.checkConnected(),this.executeNip47Request("lookup_invoice",{invoice:e.paymentRequest,payment_hash:e.paymentHash},t=>!!t.invoice,t=>({preimage:t.preimage,paymentRequest:t.invoice,paid:!!t.settled_at}))}async listTransactions(e){return await this.checkConnected(),this.executeNip47Request("list_transactions",e,t=>!!t.transactions,t=>({transactions:t.transactions.map(V)}))}request(e,t){throw new Error("Method not implemented.")}signMessage(e){throw new Error("Method not implemented.")}verifyMessage(e,t){throw new Error("Method not implemented.")}getAuthorizationUrl(e){if(!this.options.authorizationUrl)throw new Error("Missing authorizationUrl option");let t=new URL(this.options.authorizationUrl);return e!=null&&e.name&&t.searchParams.set("name",e?.name),t.searchParams.set("pubkey",this.publicKey),e!=null&&e.returnTo&&t.searchParams.set("return_to",e.returnTo),e!=null&&e.budgetRenewal&&t.searchParams.set("budget_renewal",e.budgetRenewal),e!=null&&e.expiresAt&&t.searchParams.set("expires_at",Math.floor(e.expiresAt.getTime()/1e3).toString()),e!=null&&e.maxAmount&&t.searchParams.set("max_amount",e.maxAmount.toString()),e?.editable!==void 0&&t.searchParams.set("editable",e.editable.toString()),e!=null&&e.requestMethods&&t.searchParams.set("request_methods",e.requestMethods.join(" ")),t}initNWC(e={}){e.name||(e.name=document.location.host);let t=this.getAuthorizationUrl(e),s=window.outerHeight/2+window.screenY-300,r=window.outerWidth/2+window.screenX-200;return new Promise((o,h)=>{let c=window.open(t.toString(),`${document.title} - Wallet Connect`,`height=600,width=400,top=${s},left=${r}`);if(!c)return void h();let a=p=>{let d=p.data;d&&d.type==="nwc:success"&&p.origin===`${t.protocol}//${t.host}`&&(o(d),clearInterval(l),window.removeEventListener("message",a),c&&c.close())},l=setInterval(()=>{c&&c.closed&&(h(),clearInterval(l),window.removeEventListener("message",a))},500);window.addEventListener("message",a)})}async checkConnected(){if(!this._enabled)throw new Error("please call enable() and await the promise before calling this function");if(!this.secret)throw new Error("Missing secret key");await this.relay.connect()}executeNip47Request(e,t,s,r){var o=this;let h=S[e];return new Promise((c,a)=>{(async function(){let l={method:e,params:t},p=await o.encrypt(o.walletPubkey,JSON.stringify(l)),d={kind:23194,created_at:Math.floor(Date.now()/1e3),tags:[["p",o.walletPubkey]],content:p,pubkey:o.publicKey},w=await o.signEvent(d),g=o.relay.sub([{kinds:[23195],authors:[o.walletPubkey],"#e":[w.id]}]),m=setTimeout(function(){g.unsub(),a({error:`reply timeout: event ${w.id}`,code:"INTERNAL"})},6e4);g.on("event",async function(b){clearTimeout(m),g.unsub();let $=await o.decrypt(o.walletPubkey,b.content),y;try{y=JSON.parse($)}catch{return void a({error:"invalid response",code:"INTERNAL"})}var A,P;b.kind==23195&&y.result?s(y.result)?(c(r(y.result)),o.notify(h,y.result)):a({error:"Response from NWC failed validation: "+JSON.stringify(y.result),code:"INTERNAL"}):a({error:(A=y.error)==null?void 0:A.message,code:(P=y.error)==null?void 0:P.code})});let f=setTimeout(function(){a({error:`Publish timeout: event ${w.id}`})},5e3);try{await o.relay.publish(w),clearTimeout(f)}catch(b){clearTimeout(f),a({error:`Failed to publish request: ${b}`})}})()})}};function V(n){return i({},n,{amount:Math.floor(n.amount/1e3),fees_paid:n.fees_paid?Math.floor(n.fees_paid/1e3):0})}var F=k;function U(n){let e={};return n.recipient.customKey&&n.recipient.customValue&&(e[n.recipient.customKey]=n.recipient.customValue),e[7629169]=JSON.stringify(n.boostagram),{destination:n.recipient.address,amount:n.amount,customRecords:e}}var E=class{constructor(e,t){this.auth=void 0,this.defaultRequestOptions=void 0,this.auth=typeof e=="string"?new _(e):e,this.defaultRequestOptions=i({},t,{user_agent:t?.user_agent})}accountBalance(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/balance",params:e,method:"GET"}))}accountSummary(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/summary",params:e,method:"GET"}))}accountInformation(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/me",params:e,method:"GET"}))}accountValue4Value(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/value4value",params:e,method:"GET"}))}incomingInvoices(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/incoming",params:e,method:"GET"}))}outgoingInvoices(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/outgoing",params:e,method:"GET"}))}invoices(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices",params:e,method:"GET"}))}getInvoice(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:`/invoices/${e}`,method:"GET"}))}decodeInvoice(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:`/decode/bolt11/${e}`,method:"GET"}))}createInvoice(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices",request_body:e,method:"POST"}))}keysend(e,t){let s,r;return Array.isArray(e)?(s="/payments/keysend/multi",r={keysends:e}):(s="/payments/keysend",r=e),u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:s,request_body:r,method:"POST"}))}sendPayment(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/payments/bolt11",request_body:e,method:"POST"}))}sendBoostagram(e,t){let s,r;return Array.isArray(e)?(s="/payments/keysend/multi",r={keysends:e.map(o=>U(o))}):(s="/payments/keysend",r=U(e)),u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:s,request_body:r,method:"POST"}))}sendToAlbyAccount(e,t){return console.warn("sendToAlbyAccount is deprecated. Please use sendBoostagramToAlbyAccount instead."),this.sendBoostagramToAlbyAccount(e,t)}sendBoostagramToAlbyAccount(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/payments/keysend",request_body:{destination:"030a58b8653d32b99200a2334cfe913e51dc7d155aa0116c176657a4f1722677a3",customRecords:{696969:e.account},amount:e.amount,memo:e.memo},method:"POST"}))}createWebhookEndpoint(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/webhook_endpoints",request_body:e,method:"POST"}))}deleteWebhookEndpoint(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:`/webhook_endpoints/${e}`,method:"DELETE"}))}getSwapInfo(e){return u(i({auth:this.auth},this.defaultRequestOptions,e,{endpoint:"/swaps/info",method:"GET"}))}createSwap(e,t){return u(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/swaps",method:"POST",request_body:e}))}},te={__proto__:null,NostrWebLNProvider:k,NWC:F,OauthWeblnProvider:class{constructor(n){this.client=void 0,this.auth=void 0,this.oauth=void 0,this.subscribers=void 0,this.isExecuting=void 0,this.auth=n.auth,this.client=new E(n.auth),this.oauth=!0,this.subscribers={},this.isExecuting=!1}on(n,e){this.subscribers[n]=e}notify(n,e){let t=this.subscribers[n];t&&t(e)}async enable(){var n;if(!this.isExecuting){if((n=this.auth.token)!=null&&n.access_token)return{enabled:!0};if(typeof window>"u"||window.document===void 0)throw new Error("Missing access token");try{this.isExecuting=!0,await this.openAuthorization()}finally{this.isExecuting=!1}}}async sendPayment(n){if(!this.isExecuting)try{this.isExecuting=!0;let e=await this.client.sendPayment({invoice:n});return this.notify("sendPayment",e),{preimage:e.payment_preimage}}catch(e){let t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)}finally{this.isExecuting=!1}}async keysend(n){if(!this.isExecuting)try{this.isExecuting=!0;let e=await this.client.keysend(n);return this.notify("keysend",e),{preimage:e.payment_preimage}}catch(e){let t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)}finally{this.isExecuting=!1}}async getInfo(){return{alias:"Alby"}}async makeInvoice(n){if(!this.isExecuting)try{this.isExecuting=!0;let e=await this.client.createInvoice({amount:parseInt(n.amount.toString()),description:n.defaultMemo});return this.notify("makeInvoice",e),{paymentRequest:e.payment_request}}catch(e){let t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)}finally{this.isExecuting=!1}}async openAuthorization(){var n=this;let e=window.outerHeight/2+window.screenY-350,t=window.outerWidth/2+window.screenX-300,s=await this.auth.generateAuthURL({code_challenge_method:"S256"});return new Promise((r,o)=>{let h=window.open(s,`${document.title} - WebLN enable`,`height=700,width=600,top=${e},left=${t}`),c=!1;window.addEventListener("message",async function(a){let l=a.data;if(l&&l.type==="alby:oauth:success"&&a.origin===`${document.location.protocol}//${document.location.host}`&&!c){c=!0,console.info("Processing OAuth code response");let p=l.payload.code;try{await n.auth.requestAccessToken(p),n.client=new E(n.auth),h&&h.close(),n.notify("enable"),r({enabled:!0})}catch(d){console.error(d),o({enabled:!1})}}})})}}};export{E as Client,ee as auth,Z as types,te as webln};
//# sourceMappingURL=sdk.mjs.map